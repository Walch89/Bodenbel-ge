<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>AR Bodenbelag</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-xr@latest/dist/aframe-xr.min.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene embedded xr-mode-ui="enabled: true" webxr="optionalFeatures: hit-test;">
        <a-assets>
            <img id="boden-textur" src="" crossorigin="anonymous">
        </a-assets>

        <!-- Platzhalter fÃ¼r AR-Boden -->
        <a-entity id="placement-marker" visible="false">
            <a-ring color="yellow" radius-inner="0.15" radius-outer="0.2"></a-ring>
        </a-entity>

        <!-- BodenflÃ¤che -->
        <a-plane id="boden" visible="false" rotation="-90 0 0" width="5" height="5"></a-plane>

        <a-camera position="0 1.6 0" look-controls>
            <a-cursor id="cursor" raycaster="objects: #placement-marker"></a-cursor>
        </a-camera>
    </a-scene>

    <script>
        // ðŸ”¹ Bild-URL aus GitHub holen (korrektes RAW-Format)
        function getRawGitHubURL(url) {
            return url.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/");
        }

        // ðŸ”¹ URL-Parameter auslesen (z. B. ?boden=parkett)
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] === variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return null;
        }

        // ðŸ”¹ VerfÃ¼gbare BodenbelÃ¤ge
        var bodenTyp = getQueryVariable("boden");
        var bodenBilder = {
            "parkett": getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg"),
            "fliesen": getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg"),
            "vinyl": getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg")
        };

        var bodenBild = bodenBilder[bodenTyp] || getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg");
        document.getElementById("boden-textur").setAttribute("src", bodenBild);

        // ðŸ”¹ XR Hit-Test fÃ¼r Boden-Tracking
        AFRAME.registerComponent("hit-test", {
            init: function () {
                var scene = this.el;
                var marker = document.getElementById("placement-marker");
                var boden = document.getElementById("boden");

                scene.addEventListener("enter-vr", function () {
                    if (scene.hasAttribute("xr-mode-ui")) {
                        navigator.xr.requestSession("immersive-ar", {
                            requiredFeatures: ["hit-test"]
                        }).then(session => {
                            session.requestReferenceSpace("local").then(referenceSpace => {
                                session.requestHitTestSource({ space: referenceSpace }).then(hitTestSource => {
                                    scene.setAttribute("xr-hit-test-source", hitTestSource);
                                });
                            });

                            session.addEventListener("select", function (event) {
                                let position = marker.getAttribute("position");
                                boden.setAttribute("position", position);
                                boden.setAttribute("visible", "true");
                                marker.setAttribute("visible", "false");
                            });
                        });
                    }
                });
            }
        });

        document.querySelector("a-scene").setAttribute("hit-test", "");
    </script>
</body>
</html>
