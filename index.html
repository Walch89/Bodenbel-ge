<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>AR Bodenbelag</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.3.2/aframe/build/aframe-ar.min.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;"
             vr-mode-ui="enabled: false"
             renderer="logarithmicDepthBuffer: true; precision: medium;"
             xr-mode-ui="enabled: true">
        
        <a-assets>
            <img id="boden-textur" src="" crossorigin="anonymous">
        </a-assets>

        <!-- âœ… Boden wird entweder per WebXR oder als normales 3D-Objekt gesetzt -->
        <a-entity id="boden"
                  geometry="primitive: plane; width: 5; height: 5"
                  material="src: #boden-textur"
                  position="0 0 -2"
                  rotation="-90 0 0"
                  visible="false">
        </a-entity>

        <!-- Kamera -->
        <a-camera position="0 1.6 0" look-controls wasd-controls>
            <a-cursor id="cursor" raycaster="objects: #boden"></a-cursor>
        </a-camera>
    </a-scene>

    <script>
        console.log("ðŸš€ AR-Szene gestartet");

        function getRawGitHubURL(url) {
            return url.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/");
        }

        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] === variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return null;
        }

        var bodenTyp = getQueryVariable("boden");
        console.log("ðŸ§ Bodenbelag erkannt:", bodenTyp);

        var bodenBilder = {
            "parkett": getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg"),
            "fliesen": getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg"),
            "vinyl": getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg")
        };

        var bodenBild = bodenBilder[bodenTyp] || getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg");
        console.log("ðŸŽ¨ Bild gesetzt auf:", bodenBild);

        var bodenTextur = document.getElementById("boden-textur");

        bodenTextur.onerror = function () {
            console.error("âŒ Fehler beim Laden des Bildes:", bodenBild);
        };

        bodenTextur.onload = function () {
            console.log("âœ… Bild erfolgreich geladen");
            document.getElementById("boden").setAttribute("material", "src: #boden-textur");
        };
        bodenTextur.setAttribute("src", bodenBild);

        let boden = document.getElementById("boden");

        // ðŸ”¹ WebXR testen (falls nicht verfÃ¼gbar, nutze Fallback)
        if (navigator.xr) {
            console.log("ðŸŒ WebXR ist verfÃ¼gbar!");
            document.querySelector("a-scene").setAttribute("xr-mode-ui", "enabled: true");
        } else {
            console.warn("âš ï¸ WebXR nicht unterstÃ¼tzt! Fallback-Modus aktiviert.");
            document.querySelector("a-scene").setAttribute("xr-mode-ui", "enabled: false");
            boden.setAttribute("visible", "true");
        }

        // ðŸ”¹ WebXR Plane Detection
        AFRAME.registerComponent("hit-test", {
            init: function () {
                let sceneEl = document.querySelector("a-scene");

                sceneEl.addEventListener("enter-vr", function () {
                    console.log("ðŸŒ AR-Modus aktiviert â€“ Suche nach BodenflÃ¤chen...");
                    boden.setAttribute("visible", "false");
                });

                sceneEl.addEventListener("exit-vr", function () {
                    console.log("â¹ï¸ AR-Modus beendet");
                });

                this.el.sceneEl.addEventListener("ar-hit-test-start", function (evt) {
                    console.log("ðŸ” Plane gefunden!");
                    let hitTestEntity = document.querySelector("#ar-hit-test");
                    hitTestEntity.setAttribute("visible", "true");
                });

                this.el.sceneEl.addEventListener("ar-hit-test-select", function (evt) {
                    let position = evt.detail.position;
                    console.log("ðŸ“ Boden platziert auf:", position);

                    boden.setAttribute("position", `${position.x} ${position.y} ${position.z}`);
                    boden.setAttribute("visible", "true");
                });
            }
        });

        document.querySelector("a-scene").setAttribute("hit-test", "");
    </script>

</body>
</html>
