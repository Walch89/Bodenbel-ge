<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>AR Bodenbelag</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/AR.js@1.7.2/aframe/build/aframe-ar.min.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;"
             vr-mode-ui="enabled: false"
             renderer="logarithmicDepthBuffer: true; precision: medium;">
        
        <a-assets>
            <img id="boden-textur" src="" crossorigin="anonymous">
        </a-assets>

        <!-- ✅ AR-Marker zum Erkennen (setzt nur Position) -->
        <a-marker id="boden-marker" preset="hiro"></a-marker>

        <!-- ✅ Boden wird unabhängig vom Marker gesetzt -->
        <a-entity id="boden" geometry="primitive: plane; width: 5; height: 5"
                  material="src: #boden-textur" position="0 0 -2"
                  rotation="-90 0 0" visible="false">
        </a-entity>

        <!-- Kamera -->
        <a-camera position="0 1.6 0" look-controls>
            <a-cursor id="cursor" raycaster="objects: #boden"></a-cursor>
        </a-camera>
    </a-scene>

    <script>
        console.log("🚀 AR-Szene geladen");

        // 🔹 Funktion für GitHub RAW Bild-Links
        function getRawGitHubURL(url) {
            return url.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/");
        }

        // 🔹 URL-Parameter auslesen (z. B. ?boden=parkett)
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] === variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return null;
        }

        // 🔹 Verfügbare Bodenbeläge
        var bodenTyp = getQueryVariable("boden");
        console.log("🧐 Bodenbelag erkannt:", bodenTyp);

        var bodenBilder = {
            "parkett": getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg"),
            "fliesen": getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg"),
            "vinyl": getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg")
        };

        // 🔹 Standardbild setzen, falls kein Boden ausgewählt wurde
        var bodenBild = bodenBilder[bodenTyp] || getRawGitHubURL("https://i.imgur.com/avqSYp3.jpg");
        console.log("🎨 Bild gesetzt auf:", bodenBild);

        var bodenTextur = document.getElementById("boden-textur");

        // 🔹 Falls Bild nicht geladen wird, Fehler melden
        bodenTextur.onerror = function () {
            console.error("❌ Fehler beim Laden des Bildes:", bodenBild);
        };

        // 🔹 Sobald das Bild geladen ist, setze es auf das Material
        bodenTextur.onload = function () {
            console.log("✅ Bild erfolgreich geladen");
            document.getElementById("boden").setAttribute("material", "src: #boden-textur");
        };
        bodenTextur.setAttribute("src", bodenBild);

        let markerDetected = false;

        // 🔹 Marker-Tracking → Boden bleibt auch nach Marker-Verlust sichtbar
        document.getElementById("boden-marker").addEventListener('markerFound', function(event) {
            let boden = document.getElementById("boden");
            console.log("📌 AR-Marker erkannt → Boden wird an der richtigen Stelle gesetzt");

            let markerPosition = event.target.object3D.position.clone();
            let markerY = event.target.object3D.position.y; // Höhe des Markers

            // ✅ Y-Koordinate korrigieren → 0 oder leicht über Boden
            let newY = markerY > 0 ? markerY : 0.01;  

            boden.setAttribute("position", `${markerPosition.x} ${newY} ${markerPosition.z}`);
            boden.setAttribute("visible", "true");

            markerDetected = true;
        });

        // ✅ Der Boden bleibt sichtbar, auch wenn der Marker verloren geht
        document.getElementById("boden-marker").addEventListener('markerLost', function() {
            if (markerDetected) {
                console.log("🔒 AR-Marker verloren, aber Boden bleibt sichtbar");
            }
        });

    </script>

</body>
</html>
